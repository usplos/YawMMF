MixedModelOptPower = function(
  FormulaManual = NULL,Data, DV, Fix_Factor, Re_Factor,
  Family = 'gaussian', criterionPCA = 0.01, MatrixDesign = '*', REML = F,
  Methods = 't', Nsim = 500,
  Along = NULL, maxNumber = NULL, Breaks = NULL
){
  if(!require(tidyverse)) install.packages('tidyverse')
  if(!require(lmerTest)) install.packages('lmerTest')
  if(!require(simr)) install.packages('simr')

  ##### Model optimize #####
  if(is.null(FormulaManual)){
    Fix_Factor = Fix_Factor %>% gsub(pattern = ' ',replacement = '',x = .) %>% strsplit(split = ',', fixed = T) %>% unlist()
    Re_Factor = Re_Factor %>% gsub(pattern = ' ',replacement = '',x = .) %>% strsplit(split = ',', fixed = T) %>% unlist()
    Data[Fix_Factor] = lapply(Data[Fix_Factor], factor)
    Data[Re_Factor] = lapply(Data[Re_Factor], factor)

    for(ff in Fix_Factor){
      contrasts(Data[[ff]]) = contr.simple(length(levels(Data[[ff]])))

      cat('For the fixed factor of ', ff, ', the contrasts matrix is:\n')
      print(contrasts(Data[[ff]]))
      cat('\n')
    }

    eval(parse(text = paste0('mmff = model.matrix(~ ',paste0(Fix_Factor,collapse = MatrixDesign),', Data)')))

    IVName = gsub(pattern = ':',replacement = '_',x = colnames(mmff)[2:ncol(mmff)]) %>%
      substr(x = ., start = 1, stop = nchar(.))
    Data[IVName] = mmff[,2:ncol(mmff)]
    RandomSlope = paste('(1 + ',paste(IVName,collapse = ' + '),'||',Re_Factor,')',sep = '')
    Formula = paste0(DV,' ~ 1 + ', paste(IVName,collapse = ' + '),' + ',
                     paste(RandomSlope,collapse = ' + '))
  }else{
    Formula = FormulaManual
  }


  if(Family == 'gaussian'){
    ModelAll = eval(parse(text = paste0('lmer(formula = ',Formula,', data = Data, REML = REML,',
                                        'control = lmerControl(optimizer = \'bobyqa\'))')))
  }else{
    ModelAll = eval(parse(text = paste0('glmer(formula = ',Formula,', data = Data, REML = REML,',
                                        'control = glmerControl(optimizer = \'bobyqa\'), family = \'',Family,'\')')))
  }

  if(!is.null(FormulaManual)){
    IVName = summary(ModelAll)$coef %>% row.names() %>% .[2:length(.)]
    DV = strsplit(x = FormulaManual, split = '~',fixed = T,) %>% unlist() %>% .[[1]]
  }

  PCA_All = summary(rePCA(ModelAll))
  k = 0;
  for (ii in 1:length(PCA_All)) {
    k = k + ifelse(length(PCA_All[[ii]]$importance[2,]) > 1, sum(PCA_All[[ii]]$importance[2,] < criterionPCA),0)
  }

  ModelOpt = ModelAll
  NumLoop = 0
  while (k != 0) {
    VarM = VarCorr(ModelOpt)
    NamesVarM = names(VarM)
    Group = names(VarM) %>% strsplit(x = ., split = '.', fixed = T) %>% unlist() %>% .[is.na(as.double(.))]
    Effect = c()
    Std = c()
    for(nn in 1:length(Group)){
      #nn=1
      Matrix = eval(parse(text = paste0('VarM$',NamesVarM[[nn]])))
      Effect[[nn]] = attributes(Matrix)$dimnames[[1]] %>% ifelse(test = .=='(Intercept)','1',.)
      Std[[nn]] = attributes(Matrix)$std
    }

    StdMatrix = data.frame(Group, Effect, Std)
    StdMatrixIntercept = subset(StdMatrix, Effect == '1')
    StdMatrixSlope = subset(StdMatrix, Effect != '1')
    StdMatrixSlope = StdMatrixSlope %>% arrange(-Std) %>% .[-c(nrow(.)),]
    StdMatrix = bind_rows(StdMatrixIntercept, StdMatrixSlope)

    RandomSlopeNew = StdMatrix %>% split(.$Group) %>% map_chr(function(df) {
      df = arrange(df, Effect);paste0('(',paste0(df$Effect, collapse = ' + '), ifelse(length(df$Effect) == 1,' | ',' || '), unique(df$Group),')')
    }) %>% unlist() %>% paste0(collapse = ' + ')

    FormulaNew = paste0(DV,' ~ 1 + ', paste(IVName,collapse = ' + '),' + ',
                        paste(RandomSlopeNew,collapse = ' + '))


    if(Family == 'gaussian'){
      ModelOpt = eval(parse(text = paste0('lmer(formula = ',FormulaNew,', data = Data, REML = REML,',
                                          'control = lmerControl(optimizer = \'bobyqa\'))')))
    }else{
      ModelOpt = eval(parse(text = paste0('glmer(formula = ',FormulaNew,', data = Data, REML = REML,',
                                          'control = glmerControl(optimizer = \'bobyqa\'), family = \'',Family,'\')')))
    }

    PCA_All = summary(rePCA(ModelOpt))
    k = 0;
    for (ii in 1:length(PCA_All)) {
      k = k + ifelse(length(PCA_All[[ii]]$importance[2,]) > 1, sum(PCA_All[[ii]]$importance[2,] < criterionPCA),0)
    }
    NumLoop = NumLoop+1
    if(nrow(StdMatrixSlope) == 0){
      k=0
    }
  }

  ##### power value #####
  cat('The optimized formula are:\n\n');cat(ifelse(NumLoop == 0, Formula, FormulaNew));
  cat('\n\nDo you wang to change the fixed factor?\n',
      '1: change\n',
      '0: not change')
  p = scan(nmax = 1)
  if(p == 1){
    cat('Please Input the formula of the changed model:\n')
    FormulaNew = scan(what='character',) %>% paste0(collapse = ' ')
    if(Family == 'gaussian'){
      ModelOpt = eval(parse(text = paste0('lmer(formula =', FormulaNew,', data = Data,',
                                          'control = lmerControl(optimizer = \'bobyqa\'))')))
    }else{
      ModelOpt = eval(parse(text = paste0('glmer(formula =', FormulaNew,', data = Data,',
                                          'control = glmerControl(optimizer = \'bobyqa\'), family = \'',Family,'\')')))
    }
  }

  cat('Please Input the fixed factor of which the power you want to compute:\n');FixEffect = scan(what='character',) %>% paste0(collapse = ' ')
  if(Family == 'gaussian'){
    ModelPower = eval(parse(text = paste0('lmer(formula =', FormulaNew,', data = Data,',
                                          'control = lmerControl(optimizer = \'bobyqa\'))')))
  }else{
    ModelPower = eval(parse(text = paste0('glmer(formula =', FormulaNew,', data = Data,',
                                          'control = glmerControl(optimizer = \'bobyqa\'), family = \'',Family,'\')')))
  }
  PowerList = list()
  PowerRaw = powerSim(fit = ModelPower, test = fixed(FixEffect,Methods),
                      nsim = Nsim);PowerList[[1]] = PowerRaw
  if(!is.null(Along) & !is.null(maxNumber)){
    ModelExt = extend(ModelPower, along = Along, n = maxNumber)
    if(is.null(Breaks)){
      PCurve = powerCurve(fit = ModelExt, fixed(FixEffect, Methods),
                          along = Along, nsim = Nsim)
      PowerList[[2]] = PCurve
      DF = summary(PCurve)
      PowerPlot = ggplot(DF, aes(x = nlevels, y = mean))+
        geom_point(color = gray(0))+
        geom_errorbar(aes(ymax = upper, ymin = lower, x = nlevels), color = gray(0.6),width = 1)+
        geom_line(color = gray(0.3))+
        geom_hline(yintercept = 0.8, linetype = 3)+
        theme_classic()+
        theme(panel.grid = element_blank())+
        labs(x = paste0('Number of ', PCurve$along), y = 'Power value')+
        scale_x_continuous(breaks = seq(min(DF$nlevels)%/%10*10, (max(DF$nlevels)%/%10+1)*10, 5))
      PowerList[[3]] = PowerPlot
    }else{
      PCurve = powerCurve(fit = ModelExt, fixed(FixEffect, Methods),
                          along = Along, nsim = Nsim,breaks = Breaks)
      PowerList[[2]] = PCurve
      DF = summary(PCurve)
      PowerPlot = ggplot(DF, aes(x = nlevels, y = mean))+
        geom_point(color = gray(0))+
        geom_errorbar(aes(ymax = upper, ymin = lower, x = nlevels), color = gray(0.6),width = 1)+
        geom_line(color = gray(0.3))+
        geom_hline(yintercept = 0.8, linetype = 3)+
        theme_classic()+
        theme(panel.grid = element_blank())+
        labs(x = paste0('Number of ', PCurve$along), y = 'Power value')+
        scale_x_continuous(breaks = seq(min(DF$nlevels)%/%10*10, (max(DF$nlevels)%/%10+1)*10, 5))
      PowerList[[3]] = PowerPlot
    }
  }

  #### print results ####
  if(NumLoop > 0){
    if(is.null(FormulaManual)){
      cat('\n\n####################\n\nThe formula of the maximum model was below:\n\n',
          Formula,'\n\n')
      cat('The variance correlation matrix of the maximum model was:\n\n')
      print(VarCorr(ModelAll))
      cat('\n\n####################\n\n')

      cat('HOWEVER, we suggest you use the model with the following formula:\n\n',
          FormulaNew,'\n\n####################\n\n')

      cat('The differences between the maximum model and the optimized model was calculated with anova() function, and the results were shown:\n\n')
      print(anova(ModelAll, ModelOpt))
      cat('\n\n####################\n\n');print(PowerRaw)
      cat('\n\n####################\n\n');print(PCurve)
      cat('\n\n####################\n\nThe plot of power was shown in the < Plots View >\n\n');print(PowerPlot)

      return(list(DataNew = Data,
                  Formula_All = Formula,
                  Formula_Opt = FormulaNew,
                  VarCorr_All = VarCorr(ModelAll),
                  rePCA_All = summary(rePCA(ModelAll)),
                  VarCorr_Opt = VarCorr(ModelOpt),
                  rePCA_Opt = summary(rePCA(ModelOpt)),
                  Model_Compare = anova(ModelAll, ModelOpt),
                  ModelOpt = ModelOpt,
                  Summary_ModelOpt = summary(ModelOpt),
                  ANOVA_ModelOpt = ifelse(Family == 'gaussian',
                                          anova(ModelOpt),
                                          car::Anova(ModelOpt,type = 3)),
                  PowerModelOpt = PowerList))
    }else{
      cat('\n\n####################\n\nThe formula of the model that you input was below:\n\n',
          Formula,'\n\n')
      cat('The variance correlation matrix of the given model was:\n\n')
      print(VarCorr(ModelAll))
      cat('\n\n####################\n\n')

      cat('HOWEVER, we suggest you use the model with the following formula:\n\n',
          FormulaNew,'\n\n####################\n\n')

      cat('The differences between the given model and the optimized model was calculated with anova() function, and the results were shown:\n\n')
      print(anova(ModelAll, ModelOpt))
      cat('\n\n####################\n\n');print(PowerRaw)
      cat('\n\n####################\n\n');print(PCurve)
      cat('\n\n####################\n\nThe plot of power was shown in the < Plots View >\n\n');print(PowerPlot)

      return(list(DataNew = Data,
                  Formula_Giv = Formula,
                  Formula_Opt = FormulaNew,
                  VarCorr_Giv = VarCorr(ModelAll),
                  rePCA_Giv = summary(rePCA(ModelAll)),
                  VarCorr_Opt = VarCorr(ModelOpt),
                  rePCA_Opt = summary(rePCA(ModelOpt)),
                  Model_Compare = anova(ModelAll, ModelOpt),
                  ModelOpt = ModelOpt,
                  Summary_ModelOpt = summary(ModelOpt),
                  ANOVA_ModelOpt = ifelse(Family == 'gaussian',
                                          anova(ModelOpt),
                                          car::Anova(ModelOpt,type = 3)),
                  PowerModelOpt = PowerList))
    }


  }else{
    if(is.null(FormulaManual)){
      cat('\n\n####################\n\nThe maximum model was the most suggested:\n\n',
          Formula,'\n\n')
      cat('The variance correlation matrix of the maximum model was:\n\n')
      print(VarCorr(ModelAll))
      cat('\n\n####################\n\n');print(PowerRaw)
      cat('\n\n####################\n\n');print(PCurve)
      cat('\n\n####################\n\nThe plot of power was shown in the < Plots View >\n\n');print(PowerPlot)

      return(list(DataNew = Data,
                  Formula_All = Formula,
                  VarCorr_All = VarCorr(ModelOpt),
                  rePCA_All = summary(rePCA(ModelOpt)),
                  ModelOpt = ModelOpt,
                  Summary_ModelAll = summary(ModelOpt),
                  ANOVA_ModelOpt = ifelse(Family == 'gaussian',
                                          anova(ModelOpt),
                                          car::Anova(ModelOpt,type = 3)),
                  PowerModelOpt = PowerList))
    }else{
      cat('\n\n####################\n\nThe model that you input was the most suggested:\n\n',
          Formula,'\n\n')
      cat('The variance correlation matrix of the given model was:\n\n')
      print(VarCorr(ModelAll))
      cat('\n\n####################\n\n');print(PowerRaw)
      cat('\n\n####################\n\n');print(PCurve)
      cat('\n\n####################\n\nThe plot of power was shown in the < Plots View >\n\n');print(PowerPlot)

      return(list(DataNew = Data,
                  Formula_All = Formula,
                  VarCorr_All = VarCorr(ModelOpt),
                  rePCA_All = summary(rePCA(ModelOpt)),
                  ModelOpt = ModelOpt,
                  Summary_ModelAll = summary(ModelOpt),
                  ANOVA_ModelOpt = ifelse(Family == 'gaussian',
                                          anova(ModelOpt),
                                          car::Anova(ModelOpt,type = 3)),
                  PowerModelOpt = PowerList))
    }
  }

}
